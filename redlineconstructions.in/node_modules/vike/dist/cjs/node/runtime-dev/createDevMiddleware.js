"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createDevMiddleware = createDevMiddleware;
const vite_1 = require("vite");
const prepareViteApiCall_js_1 = require("../api/prepareViteApiCall.js");
const globalContext_js_1 = require("../runtime/globalContext.js");
/*
 * Create server middleware for development with HMR and lazy-transpiling.
 *
 * https://vike.dev/createDevMiddleware
 */
async function createDevMiddleware(options = {}) {
    (0, globalContext_js_1.setGlobalContext_isProduction)(false, true);
    const optionsMod = {
        ...options,
        viteConfig: {
            ...options.viteConfig,
            root: options.root ?? options.viteConfig?.root,
            server: {
                ...options.viteConfig?.server,
                middlewareMode: options.viteConfig?.server?.middlewareMode ?? true,
            },
        },
    };
    const { viteConfigFromUserEnhanced } = await (0, prepareViteApiCall_js_1.prepareViteApiCall)(optionsMod, 'dev');
    const server = await (0, vite_1.createServer)(viteConfigFromUserEnhanced);
    const devMiddleware = server.middlewares;
    return { devMiddleware, viteServer: server, viteConfig: server.config };
}
